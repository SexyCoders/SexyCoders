<?php
function getActiveServices($data)
    {
        $ResponseData=new stdClass;
        $ResponseData->services=array();
        $groups=resolveGroup($data);
        $mongo=new MongoDB\Client("mongodb://mongo:mongo@master_mongodb:27017");
        $services_db=(($mongo)->master->services);
        foreach($groups->groups as $group){
                $t=array(
                'group'=>$group
                );
                $services=$services_db->find($t);
                foreach ($services as $service) {
                        array_push($ResponseData->services,$service);
        }

        }
    return $ResponseData;
    };

function getUserDatabases($data)
    {
        $ResponseData=new stdClass;
        $ResponseData->databases=array();
        $groups=resolveGroup($data)->groups;
        $mongo=new MongoDB\Client("mongodb://mongo:mongo@master_mongodb:27017");
        $databases_db=(($mongo)->master->databases);
        
        //get all databases where user is owner
        //$t=array('owner'=>$data->sub);
        //$databases=$databases_db->find($t);
        //foreach ($databases as $database) {
            //array_push($ResponseData->databases,$database);
        //}

        //get all databases where user is in group and group has read permissions, or where 'others' have read permissions
        //BUT user is not owner to avoid duplicates with the above query
        $matcher=array(
            'owner'=>array('$ne'=>$data->sub),
            '$or'=>array(
                array(
                    '$and'=>array(array('group'=>array('$in'=>$groups),array('permissions.g'=>array('$regex'=>'/r/')))),
                    array('permissions.o'=>array('$regex'=>'/r/'))
                )
            )
        );
        $databases1=$databases_db->find($matcher);
        foreach ($databases as $database) {
            array_push($ResponseData->databases,$database);
        }

    return $ResponseData;
    };

